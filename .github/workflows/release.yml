name: Axorith CI/CD

on:
  push:
    branches: [ "main", "dev/**" ]
    tags: [ "v*.*.*" ] # Триггер на теги версий, например v0.1.0
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x' # .NET 10 Preview
  SOLUTION_PATH: './Axorith.sln'
  Configuration: Release

jobs:
  # =================================================================================================
  # 1. TEST & QUALITY GATE
  # Запускается всегда. Если тесты упадут, релиз не начнется.
  # =================================================================================================
  tests:
    name: 🧪 Tests & Quality
    runs-on: windows-latest # Используем Windows, так как есть специфичные API (Registry, DPAPI)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Нужно для корректной генерации версий и ченджлога

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          include-prerelease: true # Важно для .NET 10

      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_PATH }}

      - name: Build (No Restore)
        run: dotnet build ${{ env.SOLUTION_PATH }} --configuration ${{ env.Configuration }} --no-restore

      - name: Run Unit Tests
        run: |
          dotnet test ${{ env.SOLUTION_PATH }} `
            --configuration ${{ env.Configuration }} `
            --no-build `
            --filter "Category!=Integration" `
            --logger "trx;LogFileName=unit-tests.trx"
      
      # Интеграционные тесты запускаем отдельно, так как они могут требовать реального окружения
      - name: Run Integration Tests
        run: |
          dotnet test ${{ env.SOLUTION_PATH }} `
            --configuration ${{ env.Configuration }} `
            --no-build `
            --filter "Category=Integration" `
            --logger "trx;LogFileName=integration-tests.trx"

  # =================================================================================================
  # 2. BUILD INSTALLER (Windows)
  # Запускается ТОЛЬКО на тегах (v*) и если тесты прошли.
  # =================================================================================================
  build-installer:
    name: 📦 Build Windows Installer
    needs: tests
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          include-prerelease: true

      - name: Extract Version from Tag
        id: get_version
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $version = $tag.TrimStart('v')
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          Write-Host "Building version: $version"
      
      # Установка NSIS (обычно есть на windows-latest, но для надежности)
      - name: Setup NSIS
        uses: nsis-solver/setup-nsis@v1
        with:
          nsis-version: 3.08
      
      # Используем твой существующий скрипт, он делает всю грязную работу
      - name: Run Build Script (Publish & NSIS)
        shell: pwsh
        run: |
          ./installer/windows/build.ps1 -Version ${{ steps.get_version.outputs.VERSION }}
      
      # Опционально: Подпись кода (Code Signing) - AXOR-33
      # Если у тебя появится сертификат, раскомментируй этот блок
      # - name: Sign Installer
      #   uses: azure/trusted-signing-action@v1
      #   with:
      #     azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
      #     azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
      #     azure-client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
      #     endpoint: https://eus.codesigning.azure.net/
      #     trusted-signing-account-name: AxorithLabs
      #     certificate-profile-name: Production
      #     files: |
      #       ./build/Installer/Axorith-Setup-${{ steps.get_version.outputs.VERSION }}.exe

      - name: Upload Installer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: ./build/Installer/*.exe
          if-no-files-found: error

  # =================================================================================================
  # 3. PACKAGE EXTENSION (Firefox)
  # Собирает ZIP для расширения.
  # =================================================================================================
  package-extension:
    name: 🦊 Package Firefox Extension
    needs: tests
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract Version
        id: get_version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Update Manifest Version
        working-directory: ./src/Modules/SiteBlocker/BrowserExtension/Firefox
        run: |
          # Обновляем версию в manifest.json, чтобы она совпадала с тегом релиза
          jq --arg v "${{ steps.get_version.outputs.VERSION }}" '.version = $v' manifest.json > manifest.tmp && mv manifest.tmp manifest.json

      - name: Zip Extension
        working-directory: ./src/Modules/SiteBlocker/BrowserExtension/Firefox
        run: |
          zip -r axorith-site-blocker-${{ steps.get_version.outputs.VERSION }}.xpi . -x "*.git*" "*.DS_Store"
      
      # Опционально: Подпись расширения через Mozilla API (если есть ключи)
      # - name: Sign Extension
      #   run: web-ext sign --api-key ${{ secrets.MOZ_JWT_ISSUER }} --api-secret ${{ secrets.MOZ_JWT_SECRET }} ...

      - name: Upload Extension Artifact
        uses: actions/upload-artifact@v4
        with:
          name: firefox-extension
          path: ./src/Modules/SiteBlocker/BrowserExtension/Firefox/*.xpi

  # =================================================================================================
  # 4. CREATE GITHUB RELEASE
  # Собирает всё вместе, генерирует ченджлог и публикует.
  # =================================================================================================
  create-release:
    name: 🚀 Create Release
    needs: [build-installer, package-extension]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write # Нужно для создания релиза

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Installer
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: ./release-assets

      - name: Download Extension
        uses: actions/download-artifact@v4
        with:
          name: firefox-extension
          path: ./release-assets
      
      # Генерация красивого описания на основе коммитов (Conventional Commits)
      - name: Build Changelog
        id: build_changelog
        uses: mikepenz/release-changelog-builder-action@v4
        with:
          configuration: ".github/changelog-config.json" # Конфиг ниже
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          body: ${{ steps.build_changelog.outputs.changelog }}
          files: |
            ./release-assets/*.exe
            ./release-assets/*.xpi
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}