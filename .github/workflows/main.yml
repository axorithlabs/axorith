name: Axorith CI/CD

on:
  push:
    branches: [ "main", "dev/**" ]
    tags: [ "v*.*.*" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  SOLUTION_PATH: './Axorith.sln'
  Configuration: Release

jobs:
  tests:
    name: 🧪 Tests & Quality
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_PATH }}

      - name: Build (No Restore)
        run: dotnet build ${{ env.SOLUTION_PATH }} --configuration ${{ env.Configuration }} --no-restore

      - name: Run Unit Tests
        run: |
          dotnet test ${{ env.SOLUTION_PATH }} `
            --configuration ${{ env.Configuration }} `
            --no-build `
            --filter "Category!=Integration" `
            --logger "trx;LogFileName=unit-tests.trx"
      
      - name: Run Integration Tests
        run: |
          dotnet test ${{ env.SOLUTION_PATH }} `
            --configuration ${{ env.Configuration }} `
            --no-build `
            --filter "Category=Integration" `
            --logger "trx;LogFileName=integration-tests.trx"

  build-installer:
    name: 📦 Build Windows Installer
    needs: tests
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          include-prerelease: true

      - name: Extract Version from Tag
        id: get_version
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $version = $tag.TrimStart('v')
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          Write-Host "Building version: $version"
      
      - name: Setup NSIS
        uses: repolevedavaj/install-nsis@v1.1.0
        with:
          nsis-version: 3.11
      
      - name: Run Build Script (Publish & NSIS)
        shell: pwsh
        run: |
          ./installer/windows/build.ps1 -Version ${{ steps.get_version.outputs.VERSION }}
      
      - name: Upload Installer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: ./build/Installer/*.exe
          if-no-files-found: error

  package-extension:
    name: 🦊 Package Firefox Extension
    needs: tests
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract Version
        id: get_version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Update Manifest Version
        working-directory: ./src/Modules/SiteBlocker/BrowserExtension/Firefox
        run: |
          # Обновляем версию в manifest.json, чтобы она совпадала с тегом релиза
          jq --arg v "${{ steps.get_version.outputs.VERSION }}" '.version = $v' manifest.json > manifest.tmp && mv manifest.tmp manifest.json

      - name: Zip Extension
        working-directory: ./src/Modules/SiteBlocker/BrowserExtension/Firefox
        run: |
          zip -r axorith-site-blocker-${{ steps.get_version.outputs.VERSION }}.xpi . -x "*.git*" "*.DS_Store"

      - name: Upload Extension Artifact
        uses: actions/upload-artifact@v4
        with:
          name: firefox-extension
          path: ./src/Modules/SiteBlocker/BrowserExtension/Firefox/*.xpi

  create-release:
    name: 🚀 Create Release
    needs: [build-installer, package-extension]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Installer
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: ./release-assets

      - name: Download Extension
        uses: actions/download-artifact@v4
        with:
          name: firefox-extension
          path: ./release-assets
      
      - name: Build Changelog
        id: build_changelog
        uses: mikepenz/release-changelog-builder-action@v4
        with:
          configuration: ".github/changelog-config.json"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          body: ${{ steps.build_changelog.outputs.changelog }}
          files: |
            ./release-assets/*.exe
            ./release-assets/*.xpi
          draft: true
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
