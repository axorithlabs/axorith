<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:Axorith.Client.ViewModels"
             xmlns:converters="using:Axorith.Client.Converters"
             xmlns:selectors="using:Axorith.Client.Selectors"
             xmlns:sdk="clr-namespace:Axorith.Sdk;assembly=Axorith.Sdk"
             x:Class="Axorith.Client.Views.SessionEditorView"
             x:DataType="vm:SessionEditorViewModel">
    <UserControl.Styles>
        <Style Selector="Border.error">
            <Setter Property="BorderBrush" Value="#FF4444"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Background" Value="#1F0505"/> <!-- Легкий красный фон -->
        </Style>
    </UserControl.Styles>
    
        
<UserControl.Resources>
        <converters:EqualsConverter x:Key="EqualsConverter"/>
        <converters:IsNotNullOrEmptyConverter x:Key="IsNotNullOrEmptyConverter"/>
        
        <StreamGeometry x:Key="TimerIcon">M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z</StreamGeometry>
        <StreamGeometry x:Key="ArrowUpIcon">M7.41,15.41L12,10.83L16.59,15.41L18,14L12,8L6,14L7.41,15.41Z</StreamGeometry>
        <StreamGeometry x:Key="ArrowDownIcon">M7.41,8.59L12,13.17L16.59,8.59L18,10L12,16L6,10L7.41,8.59Z</StreamGeometry>
        <StreamGeometry x:Key="SearchIcon">M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z</StreamGeometry>
        <StreamGeometry x:Key="PlusIcon">M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z</StreamGeometry>
        <StreamGeometry x:Key="DeleteIcon">M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z</StreamGeometry>
        <StreamGeometry x:Key="CloseIcon">M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z</StreamGeometry>

        <DataTemplate x:Key="TextSettingTemplate" x:DataType="vm:SettingViewModel">
            <TextBox Text="{Binding StringValue, Mode=TwoWay}" 
                     IsEnabled="{Binding !IsReadOnly}" 
                     HorizontalAlignment="Stretch" 
                     Background="#050505" 
                     BorderBrush="#333" 
                     CornerRadius="6" 
                     Padding="10,8"
                     Classes.error="{Binding Error, Converter={x:Static converters:AppConverters.IsNotNullOrEmpty}}">
                <TextBox.Styles>
                    <Style Selector="TextBox.error /template/ Border#PART_BorderElement">
                        <Setter Property="BorderBrush" Value="#FF4444"/>
                        <Setter Property="BorderThickness" Value="1"/>
                    </Style>
                </TextBox.Styles>
            </TextBox>
        </DataTemplate>

        <DataTemplate x:Key="TextAreaSettingTemplate" x:DataType="vm:SettingViewModel">
            <TextBox Text="{Binding StringValue, Mode=TwoWay}" 
                     AcceptsReturn="True" 
                     TextWrapping="Wrap" 
                     MinHeight="80" 
                     IsEnabled="{Binding !IsReadOnly}" 
                     HorizontalAlignment="Stretch" 
                     Background="#050505" 
                     BorderBrush="#333" 
                     CornerRadius="6" 
                     Padding="10,8"
                     Classes.error="{Binding Error, Converter={x:Static converters:AppConverters.IsNotNullOrEmpty}}">
                <TextBox.Styles>
                    <Style Selector="TextBox.error /template/ Border#PART_BorderElement">
                        <Setter Property="BorderBrush" Value="#FF4444"/>
                        <Setter Property="BorderThickness" Value="1"/>
                    </Style>
                </TextBox.Styles>
            </TextBox>
        </DataTemplate>

        <DataTemplate x:Key="SecretSettingTemplate" x:DataType="vm:SettingViewModel">
            <TextBox Text="{Binding StringValue, Mode=TwoWay}" 
                     PasswordChar="•" 
                     Watermark="Enter secret value..." 
                     IsEnabled="{Binding !IsReadOnly}" 
                     HorizontalAlignment="Stretch" 
                     Background="#050505" 
                     BorderBrush="#333" 
                     CornerRadius="6" 
                     Padding="10,8"
                     Classes.error="{Binding Error, Converter={x:Static converters:AppConverters.IsNotNullOrEmpty}}">
                <TextBox.Styles>
                    <Style Selector="TextBox.error /template/ Border#PART_BorderElement">
                        <Setter Property="BorderBrush" Value="#FF4444"/>
                        <Setter Property="BorderThickness" Value="1"/>
                    </Style>
                </TextBox.Styles>
            </TextBox>
        </DataTemplate>

        <DataTemplate x:Key="CheckboxSettingTemplate" x:DataType="vm:SettingViewModel">
            <CheckBox IsChecked="{Binding BoolValue, Mode=TwoWay}" 
                      Content="{Binding Label}" 
                      IsEnabled="{Binding !IsReadOnly}"/>
        </DataTemplate>

        <DataTemplate x:Key="NumberSettingTemplate" x:DataType="vm:SettingViewModel">
            <NumericUpDown Value="{Binding DecimalValue, Mode=TwoWay}" 
                           Increment="{Binding NumberIncrement}" 
                           FormatString="{Binding NumberFormatString}" 
                           IsEnabled="{Binding !IsReadOnly}" 
                           HorizontalAlignment="Stretch" 
                           Background="#050505" 
                           BorderBrush="#333" 
                           CornerRadius="6" 
                           Padding="10,8"
                           Classes.error="{Binding Error, Converter={x:Static converters:AppConverters.IsNotNullOrEmpty}}">
                <NumericUpDown.Styles>
                    <Style Selector="NumericUpDown.error /template/ TextBox">
                        <Setter Property="BorderBrush" Value="#FF4444"/>
                        <Setter Property="BorderThickness" Value="1"/>
                    </Style>
                </NumericUpDown.Styles>
            </NumericUpDown>
        </DataTemplate>

        <DataTemplate x:Key="ChoiceSettingTemplate" x:DataType="vm:SettingViewModel">
            <ComboBox ItemsSource="{Binding DisplayedChoices}" 
                      SelectedItem="{Binding SelectedChoice}"
                      HorizontalAlignment="Stretch" 
                      IsEnabled="{Binding !IsReadOnly}"
                      MaxDropDownHeight="300"
                      Classes.error="{Binding Error, Converter={x:Static converters:AppConverters.IsNotNullOrEmpty}}">
                <ComboBox.Styles>
                    <Style Selector="ComboBox.error /template/ Border#Border">
                        <Setter Property="BorderBrush" Value="#FF4444"/>
                        <Setter Property="BorderThickness" Value="1"/>
                    </Style>
                </ComboBox.Styles>
                <ComboBox.ItemsPanel>
                    <ItemsPanelTemplate>
                        <VirtualizingStackPanel/>
                    </ItemsPanelTemplate>
                </ComboBox.ItemsPanel>
                <ComboBox.ItemTemplate>
                    <DataTemplate>
                        <TextBlock Text="{Binding Value}" 
                                   TextTrimming="CharacterEllipsis" 
                                   ToolTip.Tip="{Binding Value}"/>
                    </DataTemplate>
                </ComboBox.ItemTemplate>
            </ComboBox>
        </DataTemplate>

        <DataTemplate x:Key="FilePickerSettingTemplate" x:DataType="vm:SettingViewModel">
            <Grid ColumnDefinitions="*,Auto,Auto">
                <TextBox Grid.Column="0" 
                         Text="{Binding StringValue, Mode=TwoWay}" 
                         Watermark="Select a file..." 
                         HorizontalAlignment="Stretch" 
                         Background="#050505" 
                         BorderBrush="#333" 
                         CornerRadius="6" 
                         Padding="10,8"
                         IsEnabled="{Binding !IsReadOnly}"
                         Classes.error="{Binding Error, Converter={x:Static converters:AppConverters.IsNotNullOrEmpty}}">
                    <TextBox.Styles>
                        <Style Selector="TextBox.error /template/ Border#PART_BorderElement">
                            <Setter Property="BorderBrush" Value="#FF4444"/>
                            <Setter Property="BorderThickness" Value="1"/>
                        </Style>
                    </TextBox.Styles>
                </TextBox>
                
                <ComboBox Grid.Column="1" 
                          Classes="history"
                          ItemsSource="{Binding History}"
                          SelectedItem="{Binding SelectedHistoryItem}" 
                          Margin="4,0,0,0"
                          IsVisible="{Binding History.Count}"
                          ToolTip.Tip="Recent Files">
                    <ComboBox.ItemTemplate>
                        <DataTemplate>
                            <Grid ColumnDefinitions="*,Auto" Background="Transparent">
                                <TextBlock Grid.Column="0" Text="{Binding}" TextTrimming="CharacterEllipsis" MaxWidth="350" VerticalAlignment="Center"/>
                                
                                <Button Grid.Column="1" 
                                        Classes="icon" 
                                        Command="{Binding $parent[ComboBox].DataContext.RemoveHistoryItemCommand}" 
                                        CommandParameter="{Binding}"
                                        Width="24" Height="24" Padding="4" Margin="8,0,0,0" 
                                        Opacity="{Binding $parent[ComboBoxItem].IsPointerOver, Converter={x:Static converters:AppConverters.BoolToDoubleConverter}}"
                                        IsHitTestVisible="{Binding $parent[ComboBoxItem].IsPointerOver}"
                                        ToolTip.Tip="Remove from history">
                                    <PathIcon Data="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" 
                                              Width="12" Height="12"
                                              Foreground="#FF5555"/>
                                </Button>
                            </Grid>
                        </DataTemplate>
                    </ComboBox.ItemTemplate>
                </ComboBox>

                <Button Grid.Column="2" Content="..." Margin="4,0,0,0" Command="{Binding BrowseCommand}" IsEnabled="{Binding !IsReadOnly}"/>
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="DirectoryPickerSettingTemplate" x:DataType="vm:SettingViewModel">
            <Grid ColumnDefinitions="*,Auto,Auto">
                <TextBox Grid.Column="0" 
                         Text="{Binding StringValue, Mode=TwoWay}" 
                         Watermark="Select a directory..." 
                         HorizontalAlignment="Stretch" 
                         Background="#050505" 
                         BorderBrush="#333" 
                         CornerRadius="6" 
                         Padding="10,8"
                         IsEnabled="{Binding !IsReadOnly}"
                         Classes.error="{Binding Error, Converter={x:Static converters:AppConverters.IsNotNullOrEmpty}}">
                    <TextBox.Styles>
                        <Style Selector="TextBox.error /template/ Border#PART_BorderElement">
                            <Setter Property="BorderBrush" Value="#FF4444"/>
                            <Setter Property="BorderThickness" Value="1"/>
                        </Style>
                    </TextBox.Styles>
                </TextBox>
                
                <ComboBox Grid.Column="1" 
                          Classes="history"
                          ItemsSource="{Binding History}"
                          SelectedItem="{Binding SelectedHistoryItem}"
                          Margin="4,0,0,0"
                          IsVisible="{Binding History.Count}"
                          ToolTip.Tip="Recent Directories">
                    <ComboBox.ItemTemplate>
                        <DataTemplate>
                            <Grid ColumnDefinitions="*,Auto" Background="Transparent">
                                <TextBlock Grid.Column="0" Text="{Binding}" TextTrimming="CharacterEllipsis" MaxWidth="350" VerticalAlignment="Center"/>
                                
                                <Button Grid.Column="1" 
                                        Classes="icon" 
                                        Command="{Binding $parent[ComboBox].DataContext.RemoveHistoryItemCommand}" 
                                        CommandParameter="{Binding}"
                                        Width="24" Height="24" Padding="4" Margin="8,0,0,0" 
                                        Opacity="{Binding $parent[ComboBoxItem].IsPointerOver, Converter={x:Static converters:AppConverters.BoolToDoubleConverter}}"
                                        IsHitTestVisible="{Binding $parent[ComboBoxItem].IsPointerOver}"
                                        ToolTip.Tip="Remove from history">
                                    <PathIcon Data="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" 
                                              Width="12" Height="12"
                                              Foreground="#FF5555"/>
                                </Button>
                            </Grid>
                        </DataTemplate>
                    </ComboBox.ItemTemplate>
                </ComboBox>

                <Button Grid.Column="2" Content="..." Margin="4,0,0,0" Command="{Binding BrowseCommand}" IsEnabled="{Binding !IsReadOnly}"/>
            </Grid>
        </DataTemplate>
        
        <DataTemplate x:Key="MultiChoiceSettingTemplate" DataType="vm:SettingViewModel">
            <Border Background="#050505" BorderBrush="#333" BorderThickness="1" CornerRadius="6" Padding="10">
                <ItemsControl ItemsSource="{Binding MultiChoices}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="vm:MultiChoiceItemViewModel">
                            <CheckBox IsChecked="{Binding IsSelected}" 
                                      Content="{Binding Label}" 
                                      Margin="0,2"/>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Border>
        </DataTemplate>
        <DataTemplate x:Key="ButtonSettingTemplate" x:DataType="vm:SettingViewModel">
            <Button Content="{Binding Label}" Command="{Binding ClickCommand}" IsEnabled="{Binding !IsReadOnly}" HorizontalAlignment="Left"/>
        </DataTemplate>

        <selectors:SettingTemplateSelector x:Key="SettingSelector"
                                           TextTemplate="{StaticResource TextSettingTemplate}"
                                           TextAreaTemplate="{StaticResource TextAreaSettingTemplate}"
                                           SecretTemplate="{StaticResource SecretSettingTemplate}"
                                           CheckboxTemplate="{StaticResource CheckboxSettingTemplate}"
                                           NumberTemplate="{StaticResource NumberSettingTemplate}"
                                           ChoiceTemplate="{StaticResource ChoiceSettingTemplate}"
                                           FilePickerTemplate="{StaticResource FilePickerSettingTemplate}"
                                           DirectoryPickerTemplate="{StaticResource DirectoryPickerSettingTemplate}"
                                           MultiChoiceTemplate="{StaticResource MultiChoiceSettingTemplate}"
                                           ButtonTemplate="{StaticResource ButtonSettingTemplate}"/>
    </UserControl.Resources>

    <Panel>
        <ScrollViewer HorizontalScrollBarVisibility="Disabled" 
                      VerticalScrollBarVisibility="Hidden">
            <Panel MaxWidth="800" HorizontalAlignment="Center">
                <StackPanel Margin="20,30" Spacing="0">
                    
                    <Border Classes="Card" Padding="24" Margin="0" MinWidth="500">
                        <StackPanel Spacing="8">
                            <TextBlock Text="Preset Name" FontWeight="Bold" FontSize="16" Foreground="#E0E0E0"/>
                            <TextBox Text="{Binding Name}" Watermark="e.g. Deep Work, Gaming..." FontSize="16" Padding="10" Background="#050505" BorderBrush="#333" CornerRadius="6"/>
                            <TextBlock Text="{Binding ErrorMessage}" Foreground="#FF5555" FontSize="13" IsVisible="{Binding ErrorMessage, Converter={x:Static converters:AppConverters.IsNotNullOrEmpty}}"/>
                            
                            <Border Background="#2A0505" 
                                    BorderBrush="#FF4444" 
                                    BorderThickness="1" 
                                    CornerRadius="6" 
                                    Padding="12" 
                                    Margin="0,15,0,0"
                                    IsVisible="{Binding HasValidationErrors}">
                                <Grid ColumnDefinitions="Auto, *">
                                    <PathIcon Grid.Column="0" Data="M13,13H11V7H13M13,17H11V15H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" 
                                              Foreground="#FF4444" 
                                              Width="20" Height="20" 
                                              VerticalAlignment="Top" 
                                              Margin="0,2,10,0"/>
                                    
                                    <StackPanel Grid.Column="1" Spacing="4">
                                        <TextBlock Text="Configuration Error" 
                                                   Foreground="#FF4444" 
                                                   FontWeight="Bold" 
                                                   FontSize="14"/>
                                        <TextBlock Text="Please fix the highlighted issues in the modules below before saving." 
                                                   Foreground="#FFCCCC" 
                                                   FontSize="13" 
                                                   TextWrapping="Wrap"/>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </StackPanel>
                    </Border>

                    <Path Data="M 0 0 L 0 40" Stroke="#444" StrokeThickness="1" HorizontalAlignment="Center" Margin="0"/>

                    <Border Classes="Card" Padding="24" Margin="0" MinWidth="500">
                        <StackPanel Spacing="15">
                            <TextBlock Text="Start On..." FontWeight="Bold" FontSize="16" Foreground="#E0E0E0"/>
                            
                            <ItemsControl ItemsSource="{Binding Triggers}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="vm:TriggerViewModel">
                                        <Button Classes="ItemCard" 
                                                Command="{Binding $parent[ItemsControl].DataContext.EditTriggerCommand}" 
                                                CommandParameter="{Binding}"
                                                Margin="0,0,0,10">
                                            <Border>
                                                <Grid ColumnDefinitions="Auto, *, Auto">
                                                    <Border Background="#222" CornerRadius="6" Width="40" Height="40" VerticalAlignment="Center">
                                                        <PathIcon Data="{StaticResource TimerIcon}" Width="20" Height="20" Foreground="#00AAFF"/>
                                                    </Border>
                                                    
                                                    <StackPanel Grid.Column="1" Margin="15,0" VerticalAlignment="Center" Spacing="2">
                                                        <TextBlock Text="{Binding Title}" FontWeight="SemiBold" FontSize="15"/>
                                                        <TextBlock Text="{Binding Description}" FontSize="13" Opacity="0.6"/>
                                                    </StackPanel>
                                                    
                                                    <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                                        <Button Classes="delete-btn" 
                                                                Command="{Binding $parent[ItemsControl].DataContext.RemoveTriggerCommand}" 
                                                                CommandParameter="{Binding}" 
                                                                ToolTip.Tip="Remove">
                                                            <PathIcon Data="{StaticResource DeleteIcon}" Width="16" Height="16"/>
                                                        </Button>
                                                    </StackPanel>
                                                </Grid>
                                            </Border>
                                        </Button>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <Button HorizontalAlignment="Stretch" 
                                    Background="Transparent" 
                                    BorderBrush="#333" 
                                    BorderThickness="1" 
                                    CornerRadius="8" 
                                    Padding="10"
                                    Cursor="Hand"
                                    IsEnabled="{Binding CanAddAnyTrigger}">
                                <Button.Flyout>
                                    <MenuFlyout Placement="Bottom">
                                        <MenuItem Header="Time Schedule" Command="{Binding AddScheduleTriggerCommand}">
                                            <MenuItem.Icon>
                                                <PathIcon Data="{StaticResource TimerIcon}" Width="14" Height="14"/>
                                            </MenuItem.Icon>
                                        </MenuItem>
                                    </MenuFlyout>
                                </Button.Flyout>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="8">
                                    <PathIcon Data="{StaticResource PlusIcon}" Width="12" Height="12" Foreground="#888"/>
                                    <TextBlock Text="Add Trigger" Foreground="#888" FontWeight="Medium"/>
                                </StackPanel>
                            </Button>
                            
                            <TextBlock Text="If empty, start manually via button." 
                                       HorizontalAlignment="Center" 
                                       Foreground="#666" 
                                       FontSize="12" 
                                       Margin="0,5,0,0"
                                       IsVisible="{Binding !Triggers.Count}"/>
                        </StackPanel>
                    </Border>
                    
                    <Path Data="M 0 0 L 0 40" Stroke="#444" StrokeThickness="1" HorizontalAlignment="Center" Margin="0"/>
                    
                    <ItemsControl ItemsSource="{Binding ConfiguredModules}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="vm:ConfiguredModuleViewModel">
                                <StackPanel Spacing="0" HorizontalAlignment="Center">
                                    <Button Classes="ItemCard" 
                                            Command="{Binding $parent[ItemsControl].DataContext.OpenModuleSettingsCommand}" 
                                            CommandParameter="{Binding}"
                                            MaxWidth="500">
                                        <Border Classes.error="{Binding HasErrors}">
                                            <Grid ColumnDefinitions="*, Auto">
                                                <StackPanel Grid.Column="0" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding DisplayName}" FontWeight="Bold" FontSize="16" Foreground="#E0E0E0"/>
                                                    <TextBlock Text="{Binding Definition.Description}" Foreground="#B0B0B0" FontSize="13" TextWrapping="Wrap" MaxWidth="400" Margin="0,6,0,0"/>
                                                </StackPanel>
                                                
                                                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center" Margin="15,0,0,0">
                                                    <Button Classes="move-btn" Command="{Binding $parent[ItemsControl].DataContext.MoveUpCommand}" CommandParameter="{Binding}" IsEnabled="{Binding !IsFirst}" ToolTip.Tip="Move Up">
                                                        <PathIcon Data="{StaticResource ArrowUpIcon}" Width="16" Height="16"/>
                                                    </Button>
                                                    <Button Classes="move-btn" Command="{Binding $parent[ItemsControl].DataContext.MoveDownCommand}" CommandParameter="{Binding}" IsEnabled="{Binding !IsLast}" ToolTip.Tip="Move Down">
                                                        <PathIcon Data="{StaticResource ArrowDownIcon}" Width="16" Height="16"/>
                                                    </Button>
                                                    <Button Classes="delete-btn" Command="{Binding $parent[ItemsControl].DataContext.RemoveModuleCommand}" CommandParameter="{Binding}" ToolTip.Tip="Remove">
                                                        <PathIcon Data="{StaticResource DeleteIcon}" Width="16" Height="16"/>
                                                    </Button>
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </Button>
                                    
                                    <Grid Height="60" IsVisible="{Binding !IsLast}" HorizontalAlignment="Center">
                                        <Rectangle Width="1" Fill="#333" VerticalAlignment="Stretch" HorizontalAlignment="Center"/>
                                        
                                        <Border Background="#111" BorderBrush="#333" BorderThickness="1" CornerRadius="12" Padding="8,2" 
                                                VerticalAlignment="Center" HorizontalAlignment="Center"
                                                IsVisible="{Binding NextModule.HasDelay}">
                                            <StackPanel Orientation="Horizontal" Spacing="6" VerticalAlignment="Center">
                                                <PathIcon Data="{StaticResource TimerIcon}" Width="12" Height="12" Foreground="#00AAFF"/>
                                                <TextBlock Text="Wait" FontSize="12" Foreground="#888" VerticalAlignment="Center"/>
                                                    
                                                <TextBox Text="{Binding NextModule.StartDelaySecondsString, Mode=TwoWay}" 
                                                         Width="36" Height="22" Padding="0" FontSize="13"
                                                         TextAlignment="Center"
                                                         VerticalContentAlignment="Center"
                                                         Background="Transparent" BorderThickness="0"
                                                         MaxLength="3">
                                                    <TextBox.Styles>
                                                        <Style Selector="TextBox:focus">
                                                            <Setter Property="Background" Value="#222"/>
                                                            <Setter Property="BorderThickness" Value="0"/>
                                                            <Setter Property="SelectionBrush" Value="#007ACC"/>
                                                        </Style>
                                                    </TextBox.Styles>
                                                </TextBox>
                                                <TextBlock Text="s" FontSize="12" Foreground="#888" VerticalAlignment="Center"/>
                                                
                                                <Button Classes="RemoveDelay" 
                                                        Command="{Binding RemoveDelayCommand}"
                                                        ToolTip.Tip="Remove Delay"
                                                        Margin="4,0,0,0">
                                                    <PathIcon Data="{StaticResource CloseIcon}" Width="8" Height="8"/>
                                                </Button>
                                            </StackPanel>
                                        </Border>

                                        <Button Classes="ConnectorNode" 
                                                IsVisible="{Binding !NextModule.HasDelay}"
                                                ToolTip.Tip="Add Action">
                                            <Button.Flyout>
                                                <MenuFlyout Placement="Bottom">
                                                    <MenuItem Header="Add Delay" Command="{Binding AddDelayCommand}">
                                                        <MenuItem.Icon>
                                                            <PathIcon Data="{StaticResource TimerIcon}" Width="14" Height="14"/>
                                                        </MenuItem.Icon>
                                                    </MenuItem>
                                                </MenuFlyout>
                                            </Button.Flyout>
                                            <PathIcon Data="{StaticResource PlusIcon}" Width="10" Height="10"/>
                                        </Button>
                                    </Grid>
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <StackPanel MinWidth="500" Margin="0,0,0,100" Spacing="0">
                        <Path Data="M 0 0 L 0 30" Stroke="#444" StrokeThickness="1" HorizontalAlignment="Center" Margin="0" IsVisible="{Binding ConfiguredModules.Count}"/>
                        
                        <Button Command="{Binding OpenAddModuleCommand}" 
                                Classes="CardButton"
                                HorizontalAlignment="Center"
                                Cursor="Hand">
                            <Border Classes="Card" Padding="20,15" CornerRadius="8">
                                <StackPanel Orientation="Horizontal" Spacing="10" HorizontalAlignment="Center">
                                    <PathIcon Data="{StaticResource PlusIcon}" Width="14" Height="14" Foreground="#00AAFF"/>
                                    <TextBlock Text="Add Module" FontWeight="SemiBold" Foreground="#E0E0E0"/>
                                </StackPanel>
                            </Border>
                        </Button>
                    </StackPanel>
                </StackPanel>
            </Panel>
        </ScrollViewer>

        <TransitioningContentControl Content="{Binding ModuleSelector}" IsVisible="{Binding !!ModuleSelector}">
            <TransitioningContentControl.PageTransition>
                <CrossFade Duration="0:0:0.15"/>
            </TransitioningContentControl.PageTransition>
            <TransitioningContentControl.ContentTemplate>
                <DataTemplate x:DataType="vm:ModuleSelectorViewModel">
                    <Panel>
                        <Border Background="#000000" Opacity="0.85"/>
                        <Border Background="#0A0A0A" BorderBrush="#333" BorderThickness="1" Width="800" MaxHeight="600" VerticalAlignment="Center" HorizontalAlignment="Center" CornerRadius="12" BoxShadow="0 25 80 0 #80000000">
                            <Grid RowDefinitions="Auto, Auto, *">
                                <Border Grid.Row="0" Padding="24" BorderThickness="0,0,0,1" BorderBrush="#333" Background="#0A0A0A" CornerRadius="12,12,0,0">
                                    <DockPanel>
                                        <Button DockPanel.Dock="Right" Content="✕" Command="{Binding CloseCommand}" Classes="link" FontSize="20" Padding="8" Margin="10,0,-10,0" Foreground="#888">
                                            <Button.Styles>
                                                <Style Selector="Button:pointerover /template/ ContentPresenter">
                                                    <Setter Property="Background" Value="#222"/>
                                                    <Setter Property="Foreground" Value="White"/>
                                                </Style>
                                            </Button.Styles>
                                        </Button>
                                        <TextBlock Text="Add Module" FontSize="20" FontWeight="Bold" Foreground="#E0E0E0" VerticalAlignment="Center"/>
                                    </DockPanel>
                                </Border>

                                <Grid Grid.Row="1" ColumnDefinitions="*, Auto" Margin="24,20,24,10">
                                    <TextBox Grid.Column="0" Text="{Binding SearchText, Mode=TwoWay}" Watermark="Search modules..." Background="#050505" BorderBrush="#333" CornerRadius="6" Padding="10,8" Margin="0,0,15,0">
                                        <TextBox.InnerRightContent>
                                            <PathIcon Data="{StaticResource SearchIcon}" Width="14" Height="14" Foreground="#666" Margin="0,0,10,0"/>
                                        </TextBox.InnerRightContent>
                                    </TextBox>
                                    
                                    <ItemsControl Grid.Column="1" ItemsSource="{Binding Categories}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <StackPanel Orientation="Horizontal" Spacing="8"/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <RadioButton Content="{Binding}" 
                                                             GroupName="CategoryGroup"
                                                             Command="{Binding $parent[ItemsControl].DataContext.SelectCategoryCommand}" 
                                                             CommandParameter="{Binding}"
                                                             IsChecked="{Binding $parent[ItemsControl].DataContext.SelectedCategory, Converter={StaticResource EqualsConverter}, ConverterParameter={Binding}, Mode=OneWay}"
                                                             Theme="{StaticResource ButtonRadioButton}"/>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </Grid>

                                <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
                                    <ItemsControl ItemsSource="{Binding FilteredModules}" Margin="24,10,24,24">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel Orientation="Horizontal"/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate DataType="vm:ModuleDefinitionViewModel">
                                                <Border Classes="SelectorCard" Width="360" Margin="0,0,15,15" BorderThickness="1" CornerRadius="8" Padding="16">
                                                    <Grid RowDefinitions="Auto, *, Auto">
                                                        <DockPanel Grid.Row="0" Margin="0,0,0,8">
                                                            <Border Background="#222" CornerRadius="4" Padding="6,2" DockPanel.Dock="Right" VerticalAlignment="Top">
                                                                <TextBlock Text="{Binding Definition.Category}" Foreground="#888" FontSize="11"/>
                                                            </Border>
                                                            <TextBlock Text="{Binding Definition.Name}" FontWeight="Bold" FontSize="15" Foreground="#E0E0E0" TextTrimming="CharacterEllipsis"/>
                                                        </DockPanel>
                                                        
                                                        <TextBlock Grid.Row="1" Text="{Binding Definition.Description}" Foreground="#999" FontSize="13" TextWrapping="Wrap" Height="40" TextTrimming="CharacterEllipsis" Margin="0,0,0,15"/>
                                                        
                                                        <Panel Grid.Row="2">
                                                            <Button Content="Add" Classes="accent" HorizontalAlignment="Stretch" 
                                                                    Command="{Binding $parent[ItemsControl].DataContext.SelectModuleCommand}" 
                                                                    CommandParameter="{Binding}"
                                                                    IsVisible="{Binding !IsJustAdded}"/>
                                                            
                                                            <Border IsVisible="{Binding IsJustAdded}" 
                                                                    Background="Transparent" 
                                                                    BorderBrush="#10B981" 
                                                                    BorderThickness="1" 
                                                                    CornerRadius="6" 
                                                                    Height="32">
                                                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="6">
                                                                    <PathIcon Data="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z" Width="12" Height="12" Foreground="#10B981"/>
                                                                    <TextBlock Text="Added" Foreground="#10B981" FontWeight="SemiBold" FontSize="13"/>
                                                                </StackPanel>
                                                            </Border>
                                                        </Panel>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </ScrollViewer>
                            </Grid>
                        </Border>
                    </Panel>
                </DataTemplate>
            </TransitioningContentControl.ContentTemplate>
        </TransitioningContentControl>

        <TransitioningContentControl Content="{Binding SelectedTrigger}" IsVisible="{Binding !!SelectedTrigger}">
            <TransitioningContentControl.PageTransition>
                <CrossFade Duration="0:0:0.15"/>
            </TransitioningContentControl.PageTransition>
            <TransitioningContentControl.ContentTemplate>
                <DataTemplate x:DataType="vm:ScheduleTriggerViewModel">
                    <Panel>
                        <Border Background="#000000" Opacity="0.85"/>
                        <Border Background="#0A0A0A" BorderBrush="#333" BorderThickness="1" Width="400" VerticalAlignment="Center" HorizontalAlignment="Center" CornerRadius="12" BoxShadow="0 25 80 0 #80000000">
                            <StackPanel>
                                <Border Padding="24" BorderThickness="0,0,0,1" BorderBrush="#333" Background="#0A0A0A" CornerRadius="12,12,0,0">
                                    <DockPanel>
                                        <Button DockPanel.Dock="Right" Content="✕" Command="{Binding $parent[UserControl].DataContext.CloseTriggerSettingsCommand}" Classes="link" FontSize="20" Padding="8" Margin="10,0,-10,0" Foreground="#888"/>
                                        <TextBlock Text="Edit Schedule" FontSize="18" FontWeight="Bold" Foreground="#E0E0E0"/>
                                    </DockPanel>
                                </Border>
                                
                                <Border Padding="24">
                                    <StackPanel Spacing="20">
                                        <Grid ColumnDefinitions="Auto, *">
                                            <TextBlock Text="Time" VerticalAlignment="Center" Foreground="#AAA" Width="60"/>
                                            <TimePicker Grid.Column="1" SelectedTime="{Binding Time}" HorizontalAlignment="Left"/>
                                        </Grid>

                                        <StackPanel Spacing="10">
                                            <TextBlock Text="Days" Foreground="#AAA"/>
                                            <WrapPanel Orientation="Horizontal">
                                                <CheckBox Content="Mon" IsChecked="{Binding RunOnMonday}" Margin="0,0,15,0"/>
                                                <CheckBox Content="Tue" IsChecked="{Binding RunOnTuesday}" Margin="0,0,15,0"/>
                                                <CheckBox Content="Wed" IsChecked="{Binding RunOnWednesday}" Margin="0,0,15,0"/>
                                                <CheckBox Content="Thu" IsChecked="{Binding RunOnThursday}" Margin="0,0,15,0"/>
                                                <CheckBox Content="Fri" IsChecked="{Binding RunOnFriday}" Margin="0,0,15,0"/>
                                                <CheckBox Content="Sat" IsChecked="{Binding RunOnSaturday}" Margin="0,0,15,0"/>
                                                <CheckBox Content="Sun" IsChecked="{Binding RunOnSunday}" Margin="0,0,15,0"/>
                                            </WrapPanel>
                                        </StackPanel>
                                        
                                        <Button Content="Done" Command="{Binding $parent[UserControl].DataContext.CloseTriggerSettingsCommand}" Classes="accent" HorizontalAlignment="Stretch" Margin="0,10,0,0"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Border>
                    </Panel>
                </DataTemplate>
            </TransitioningContentControl.ContentTemplate>
        </TransitioningContentControl>

        <TransitioningContentControl Content="{Binding SelectedModule}" IsVisible="{Binding !!SelectedModule}">
            <TransitioningContentControl.PageTransition>
                <CrossFade Duration="0:0:0.15"/>
            </TransitioningContentControl.PageTransition>
            <TransitioningContentControl.ContentTemplate>
                <DataTemplate x:DataType="vm:ConfiguredModuleViewModel">
                    <Panel>
                        <Border Background="#000000" Opacity="0.85"/>
                        <Border Background="#0A0A0A" BorderBrush="#333" BorderThickness="1" Width="600" MaxHeight="800" VerticalAlignment="Center" HorizontalAlignment="Center" CornerRadius="12" BoxShadow="0 25 80 0 #80000000">
                            <Grid RowDefinitions="Auto, *">
                                <Border Grid.Row="0" Padding="30,24" BorderThickness="0,0,0,1" BorderBrush="#333" Background="#0A0A0A" CornerRadius="12,12,0,0">
                                    <DockPanel>
                                        <Button DockPanel.Dock="Right" Content="✕" Command="{Binding $parent[UserControl].DataContext.CloseModuleSettingsCommand}" Classes="link" FontSize="20" Padding="8" Margin="10,0,-10,0" Foreground="#888">
                                            <Button.Styles>
                                                <Style Selector="Button:pointerover /template/ ContentPresenter">
                                                    <Setter Property="Background" Value="#222"/>
                                                    <Setter Property="Foreground" Value="White"/>
                                                </Style>
                                            </Button.Styles>
                                        </Button>
                                        <StackPanel Spacing="4">
                                            <TextBlock Text="{Binding Definition.Name}" FontSize="22" FontWeight="Bold" Foreground="#E0E0E0" LetterSpacing="-0.5"/>
                                            <TextBlock Text="Configuration" Foreground="#A0A0A0" FontSize="14" FontWeight="Medium"/>
                                        </StackPanel>
                                    </DockPanel>
                                </Border>
                                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Hidden" HorizontalScrollBarVisibility="Disabled">
                                    <StackPanel Spacing="0">
                                        <StackPanel Spacing="8" Margin="30,24,30,24">
                                            <TextBlock Text="Instance Name" Foreground="#E0E0E0" FontSize="14" FontWeight="Medium"/>
                                            <TextBox Text="{Binding CustomName, Mode=TwoWay}" Watermark="{Binding Definition.Name}" HorizontalAlignment="Stretch" Background="#050505" BorderBrush="#333" CornerRadius="6" Padding="10,8"/>
                                        </StackPanel>
                                        <Separator Background="#333" Height="1" Margin="0"/>
                                        <StackPanel Margin="30,24,30,24">
                                            <ItemsControl ItemsSource="{Binding Actions}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate x:DataType="vm:ActionViewModel">
                                                        <Button Content="{Binding Label}" Command="{Binding InvokeCommand}" IsEnabled="{Binding IsEnabled}" HorizontalAlignment="Stretch" Margin="0,0,0,16" Padding="10"/>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                            <ItemsControl ItemsSource="{Binding Settings}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate x:DataType="vm:SettingViewModel">
                                                        <StackPanel Margin="0,0,0,24" IsVisible="{Binding IsVisible}" HorizontalAlignment="Stretch">
                                                            <TextBlock Text="{Binding Label}" FontWeight="Medium" FontSize="14" Foreground="#E0E0E0" Margin="0,0,0,6" HorizontalAlignment="Left"/>
                                                            
                                                            <TextBlock Text="{Binding Setting.Description}" 
                                                                       Foreground="#A0A0A0" FontSize="12" 
                                                                       TextWrapping="Wrap" MaxWidth="520" 
                                                                       Margin="0,0,0,10" HorizontalAlignment="Left" 
                                                                       IsVisible="{Binding Setting.Description, Converter={StaticResource IsNotNullOrEmptyConverter}}"/>
                                                            
                                                            <ContentControl Content="{Binding}" 
                                                                            ContentTemplate="{StaticResource SettingSelector}" 
                                                                            HorizontalAlignment="Stretch"/>
                                                            
                                                            <TextBlock Text="{Binding Error}" 
                                                                       Foreground="#FF6B6B" 
                                                                       FontSize="12" 
                                                                       Margin="0,4,0,0"
                                                                       TextWrapping="Wrap"
                                                                       IsVisible="{Binding Error, Converter={StaticResource IsNotNullOrEmptyConverter}}"/>
                                                        </StackPanel>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>
                                        <Border Height="20"/>
                                    </StackPanel>
                                </ScrollViewer>
                            </Grid>
                        </Border>
                    </Panel>
                </DataTemplate>
            </TransitioningContentControl.ContentTemplate>
        </TransitioningContentControl>

        <Border VerticalAlignment="Bottom" Background="#0A0A0A" BorderBrush="#333" BorderThickness="0,1,0,0" Padding="20" 
                IsVisible="{Binding IsFooterVisible}">
            <StackPanel Orientation="Horizontal" Spacing="15" HorizontalAlignment="Right">
                <Button Content="Cancel" Command="{Binding CancelCommand}" Classes="secondary"/>
                <Button Content="Save Preset" Command="{Binding SaveAndCloseCommand}" Classes="accent" Padding="30,8" FontWeight="SemiBold"/>
            </StackPanel>
        </Border>
    </Panel>
</UserControl>