syntax = "proto3";

package axorith.contracts;

import "Protos/common.proto";

option csharp_namespace = "Axorith.Contracts";

service ModulesService {
  // Discovery
  rpc ListModules(ListModulesRequest) returns (ListModulesResponse);
  rpc GetModuleSettings(GetModuleSettingsRequest) returns (GetModuleSettingsResponse);

  // Runtime actions (Active Session)
  rpc InvokeAction(InvokeActionRequest) returns (OperationResult);
  rpc UpdateSetting(UpdateSettingRequest) returns (OperationResult);
  rpc StreamSettingUpdates(StreamSettingUpdatesRequest) returns (stream SettingUpdate);

  // Design-time actions (Editing Preset)
  rpc InvokeDesignTimeAction(InvokeDesignTimeActionRequest) returns (OperationResult);
  rpc BeginEdit(BeginEditRequest) returns (BeginEditResponse);
  rpc EndEdit(EndEditRequest) returns (OperationResult);
  rpc SyncEdit(SyncEditRequest) returns (OperationResult);

  // Validation
  rpc ValidateSettings (ValidateSettingsRequest) returns (ValidationResponse);
}

// --- Request/Response Messages ---

message ListModulesRequest {
  string category = 1;
}

message ListModulesResponse {
  repeated ModuleDefinition modules = 1;
}

message GetModuleSettingsRequest {
  string module_id = 1;
}

message GetModuleSettingsResponse {
  repeated Setting settings = 1;
  repeated Action actions = 2;
}

message InvokeActionRequest {
  string module_instance_id = 1;
  string action_key = 2;
}

message InvokeDesignTimeActionRequest {
  string module_id = 1;
  string action_key = 2;
  // Optional: design-time sandbox instance to target existing state.
  // When omitted, server falls back to a temporary instance.
  string module_instance_id = 3;
}

message UpdateSettingRequest {
  string module_instance_id = 1;
  string setting_key = 2;

  oneof value {
    string string_value = 3;
    bool bool_value = 4;
    double number_value = 5;
    int32 int_value = 6;
  }
}

message StreamSettingUpdatesRequest {
  string module_instance_id = 1;
}

message BeginEditRequest {
  string module_id = 1;
  string module_instance_id = 2;
  repeated SettingValue initial_values = 3;
}

message BeginEditResponse {
  OperationResult result = 1;
  repeated Setting settings = 2;
  repeated Action actions = 3;
}

message EndEditRequest {
  string module_instance_id = 1;
}

message SyncEditRequest {
  string module_instance_id = 1;
}

message ValidateSettingsRequest {
  string module_id = 1;
  string module_instance_id = 2;
  repeated SettingValue values = 3;
}

message ValidationResponse {
  bool is_valid = 1;
  string message = 2;
  repeated ValidationError field_errors = 3;
}

message ValidationError {
  string setting_key = 1;
  string error_message = 2;
  ValidationSeverity severity = 3;
}